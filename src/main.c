#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <unistd.h>

#define STB_IMAGE_IMPLEMENTATION
#include "stb_image.h"

#define STB_IMAGE_WRITE_IMPLEMENTATION
#include "stb_image_write.h"

#define ASCII_CHARS "@#&$%8BWM#oahkbdpqwmzcvunxrjft|-+~<>iI;:,.` "

#define CHAR_SIZE 8

unsigned char font[128][8] = {
    ['@'] = {0x3C, 0x42, 0xA5, 0xA9, 0xB1, 0x42, 0x3C, 0x00},
    ['#'] = {0x24, 0x24, 0xFF, 0x24, 0xFF, 0x24, 0x24, 0x00},
    ['&'] = {0x30, 0x48, 0x30, 0x76, 0x89, 0x89, 0x76, 0x00},
    ['$'] = {0x10, 0x3E, 0x40, 0x3C, 0x02, 0x7C, 0x10, 0x00},
    ['%'] = {0x60, 0x92, 0x64, 0x08, 0x16, 0x29, 0x06, 0x00},
    ['8'] = {0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00},
    ['B'] = {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00},
    ['W'] = {0x81, 0x81, 0x81, 0xA5, 0x5A, 0x5A, 0x24, 0x00},
    ['M'] = {0x81, 0xC3, 0xA5, 0x99, 0x81, 0x81, 0x81, 0x00},
    ['o'] = {0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00},
    ['a'] = {0x00, 0x00, 0x3C, 0x42, 0x7E, 0x42, 0x3E, 0x00},
    ['h'] = {0x40, 0x40, 0x7C, 0x42, 0x42, 0x42, 0x42, 0x00},
    ['k'] = {0x40, 0x40, 0x4C, 0x50, 0x60, 0x50, 0x4C, 0x00},
    ['b'] = {0x20, 0x20, 0x3C, 0x22, 0x22, 0x22, 0x3C, 0x00},
    ['d'] = {0x02, 0x02, 0x3E, 0x42, 0x42, 0x42, 0x3E, 0x00},
    ['p'] = {0x00, 0x00, 0x3C, 0x42, 0x42, 0x3C, 0x40, 0x40},
    ['q'] = {0x00, 0x00, 0x3E, 0x42, 0x42, 0x3E, 0x02, 0x02},
    ['w'] = {0x00, 0x00, 0x42, 0x42, 0x5A, 0x5A, 0x24, 0x00},
    ['m'] = {0x00, 0x00, 0x6C, 0x52, 0x52, 0x52, 0x42, 0x00},
    ['z'] = {0x00, 0x00, 0x7E, 0x04, 0x18, 0x20, 0x7E, 0x00},
    ['c'] = {0x00, 0x00, 0x3C, 0x42, 0x40, 0x42, 0x3C, 0x00},
    ['v'] = {0x00, 0x00, 0x42, 0x42, 0x24, 0x18, 0x18, 0x00},
    ['u'] = {0x00, 0x00, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x00},
    ['n'] = {0x00, 0x00, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x00},
    ['x'] = {0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00},
    ['r'] = {0x00, 0x00, 0x5C, 0x62, 0x40, 0x40, 0x40, 0x00},
    ['j'] = {0x00, 0x00, 0x1E, 0x04, 0x04, 0x44, 0x38, 0x00},
    ['f'] = {0x0C, 0x10, 0x10, 0x3E, 0x10, 0x10, 0x10, 0x00},
    ['t'] = {0x10, 0x10, 0x7E, 0x10, 0x10, 0x12, 0x0C, 0x00},
    ['|'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['-'] = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
    ['+'] = {0x00, 0x10, 0x10, 0x7E, 0x10, 0x10, 0x00, 0x00},
    ['~'] = {0x00, 0x32, 0x4C, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['<'] = {0x00, 0x0C, 0x30, 0xC0, 0x30, 0x0C, 0x00, 0x00},
    ['>'] = {0x00, 0xC0, 0x30, 0x0C, 0x30, 0xC0, 0x00, 0x00},
    ['i'] = {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00},
    ['I'] = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    [';'] = {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x10, 0x00},
    [':'] = {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00},
    [','] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00},
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00},
    ['`'] = {0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

int main(int argc, char **argv) {
    if (argc < 3) {
        fprintf(stderr, "Usage: %s <input_image_path> <output_image_path>\n", argv[0]);
        return EXIT_FAILURE;
    }

    int width, height, channels;
    unsigned char *img = stbi_load(argv[1], &width, &height, &channels, 0);

    if (!img) {
        fprintf(stderr, "Failed to load image from %s.\n", argv[1]);
        return EXIT_FAILURE;
    }

    int scaled_width = width / CHAR_SIZE;
    int scaled_height = height / CHAR_SIZE;

    int output_width = scaled_width * CHAR_SIZE;
    int output_height = scaled_height * CHAR_SIZE;

    unsigned char *output_buffer = calloc(output_width * output_height * 3, sizeof(unsigned char));
    if (!output_buffer) {
        fprintf(stderr, "Failed to allocate image buffer.\n");
        stbi_image_free(img);
        return EXIT_FAILURE;
    }

    unsigned char bg_color = 128;
    for (int i = 0; i < output_width * output_height * 3; i++) {
        output_buffer[i] = bg_color;
    }

    for (int y = 0; y < scaled_height; y++) {
        for (int x = 0; x < scaled_width; x++) {
            int src_x = x * CHAR_SIZE;
            int src_y = y * CHAR_SIZE;
            int index = (src_y * width + src_x) * channels;

            int r = img[index + 0];
            int g = img[index + 1];
            int b = img[index + 2];

            float grayscale = (0.299f * r + 0.587f * g + 0.114f * b) / 255.0f;

            float gamma = 2.2f;
            float corrected_grayscale = pow(grayscale, 1.0f / gamma);

            int num_chars = strlen(ASCII_CHARS);
            int gray_index = (int) (corrected_grayscale * (num_chars - 1));
            unsigned char ascii_character = ASCII_CHARS[gray_index];


            float contrast_factor = 0.6f; 
            float avg_brightness = grayscale * 255.0f;

            unsigned char bg_r = r;
            unsigned char bg_g = g;
            unsigned char bg_b = b;

            unsigned char fg_r = bg_r * contrast_factor;
            unsigned char fg_g = bg_g * contrast_factor;
            unsigned char fg_b = bg_b * contrast_factor;

            if (avg_brightness > 128) {
                fg_r = bg_r * (1.0f - contrast_factor);
                fg_g = bg_g * (1.0f - contrast_factor);
                fg_b = bg_b * (1.0f - contrast_factor);
            } else {
                fg_r = bg_r + (255.0f - bg_r) * contrast_factor;
                fg_g = bg_g + (255.0f - bg_g) * contrast_factor;
                fg_b = bg_b + (255.0f - bg_b) * contrast_factor;
            }

            for (int dy = 0; dy < CHAR_SIZE; dy++) {
                for (int dx = 0; dx < CHAR_SIZE; dx++) {
                    int pixel_x = x * CHAR_SIZE + dx;
                    int pixel_y = y * CHAR_SIZE + dy;
                    int index = (pixel_y * output_width + pixel_x) * 3;

                    unsigned char pixel_on = font[ascii_character][dy] & (1 << (7 - dx));
                    if (pixel_on) {
                        output_buffer[index] = fg_r;
                        output_buffer[index + 1] = fg_g;
                        output_buffer[index + 2] = fg_b;
                    } else {
                        output_buffer[index] = bg_r;
                        output_buffer[index + 1] = bg_g;
                        output_buffer[index + 2] = bg_b;
                    }
                }
            }
        }
    }

    if (stbi_write_jpg(argv[2], output_width, output_height, 3, output_buffer, 100)) {
        printf("Saved ASCII art image to %s\n", argv[2]);
    } else {
        fprintf(stderr, "Failed to save ASCII image to %s.\n", argv[2]);
    }

    free(output_buffer);
    stbi_image_free(img);    

    return EXIT_SUCCESS;
}